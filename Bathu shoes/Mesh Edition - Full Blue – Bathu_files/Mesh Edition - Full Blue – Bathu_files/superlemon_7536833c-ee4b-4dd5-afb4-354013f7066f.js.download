function initJQuery(onJQueryLoad) {
  if (typeof (jQuery) == 'undefined') {
    (function () {
      // Load jquery script if doesn't exist
      var script = document.createElement("SCRIPT");
      script.src = 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js';
      script.type = 'text/javascript';
      script.onload = onJQueryLoad;
      document.head.appendChild(script);
    })();
  } else {
    onJQueryLoad()
  }
}

function initCss(done) {
  var link = document.createElement('link');
  link.setAttribute("rel", "stylesheet");
  link.setAttribute("type", "text/css");
  link.onload = done;
  link.setAttribute("href", "https://cdn.shopify.com/s/files/1/0070/3666/5911/files/superlemon_86166514-deb7-43dc-8b2f-74484eaaeaf7.css?v=1616564329");
  document.head.appendChild(link);
}


function btnLoad() {
  var me = document.currentScript;

  if (jQuery("#tadpole-script").length) {
    return;
  }

  const SERVER_BASE_URL = "https://app.superlemon.xyz";


  function getFinalWhatsappShareMsg(settings) {
    return encodeURIComponent(window.location.href.split('?')[0]) + "%0A%0A" + encodeURIComponent(settings.prefilled_msg)
  }

  function getFinalWhatsappMsg(settings) {
    if (settings.include_product_link) {
      return encodeURIComponent(window.location.href.split('?')[0]) + "%0A%0A" + encodeURIComponent(settings.prefilled_msg)
    } else {
      return encodeURIComponent(settings.prefilled_msg)
    }
  }

  function onChatInitiated(settings, agent_id) {

    jQuery.ajax({
      url: SERVER_BASE_URL + '/chatlytics/chat?shop_id=' + shop_id + '&url_path=' + window.location.pathname + "&agent_id=" + (agent_id || ''),
      type: 'GET'
    });

    var ga = window.ga;
    // fire the GA event.
    if (settings.is_google_analytics_enabled && ga) {
      ga('send', {
        hitType: 'event',
        eventCategory: settings.google_analytics_event_category,
        eventAction: settings.google_analytics_event_action,
        eventLabel: settings.google_analytics_event_label
      });
    }

    var fbq = window.fbq;
    // fire the Fb pixel event.
    if (settings.is_facebook_pixel_enabled && fbq) {
      fbq('track', settings.fb_pixel_event_name, {});
    }

  }

  function onShareBtnClick(link) {
    return function () {
      jQuery.ajax({
        url: SERVER_BASE_URL + '/chatlytics/share?shop_id=' + shop_id + '&url_path=' + window.location.pathname,
        type: 'GET'
      });
      openInNewTab(link);
    }
  }

  mobilecheck = function () {
    var check = false;
    (function (a) {
      if (/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(a) || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0, 4))) check = true;
    })(navigator.userAgent || navigator.vendor || window.opera);
    return check;
  };

  function deviceType() {
    if (mobilecheck()) {
      return 1;
    } else {
      return 2;
    }
  }

  function getHeightOffset(current_device_type, settings) {
    if (current_device_type == 1) {
      return settings.is_product_page_height_set && isProductPage() ? settings.mobile_offset_product_page : settings.mobile_offset
    } else if (current_device_type == 2) {
      return settings.is_product_page_height_set && isProductPage() ? settings.desktop_offset_product_page : settings.desktop_offset
    }
  }

  function getHorizontalOffset(current_device_type, settings) {
    if (current_device_type == 1) {
      return settings.horizontal_offset_mobile
    } else if (current_device_type == 2) {
      return settings.horizontal_offset_desktop
    }
  }

  function getButtonPosition(current_device_type, settings) {
    var pos;
    if (current_device_type == 1) {
      pos = settings.btn_pos_mobile
    } else if (current_device_type == 2) {
      pos = settings.btn_pos_desktop
    }

    if (!pos) {
      pos = settings.btn_pos ? settings.btn_pos : "right"
    }

    return pos;
  }

  function getCloseButton() {
    var closeBtn = document.createElement('div')
    closeBtn.className = "wa-chat-bubble-close-btn"
    closeBtn.innerHTML = '<img style="display: table-row" src="https://cdn.shopify.com/s/files/1/0070/3666/5911/files/Vector.png?574">';

    closeBtn.onclick = function () {
      // jQuery("#wa-chat-bubble").slideToggle();

      // new bouncedown greeting widget animation
      jQuery("#wa-chat-bubble").removeClass("bounceUp");
      jQuery("#wa-chat-bubble").addClass("bounceDown");
      jQuery("#wa-chat-btn-root").show();
    }
    return closeBtn
  }

  function getHeaderTitle(settings, customStyle = '') {
    var headerTitle = document.createElement('div')
    headerTitle.className = "wa-chat-bubble-header-title"
    headerTitle.innerHTML = settings.multi_agent_title
    headerTitle.style = customStyle;
    return headerTitle
  }

  function getHeaderDesc(settings, customStyle = '') {
    var headerDesc = document.createElement('div')
    headerDesc.className = "wa-chat-bubble-header-desc"
    headerDesc.innerHTML = settings.multi_agent_msg;
    headerDesc.style = customStyle;
    return headerDesc
  }

  function getCustomerSuportOnClick(link, settings, agent_id) {
    return function () {
      onChatInitiated(settings, agent_id)
      openInNewTab(link);
    }
  }

  function shuffle(array) {
    var currentIndex = array.length, temporaryValue, randomIndex;

    // While there remain elements to shuffle...
    while (0 !== currentIndex) {

      // Pick a remaining element...
      randomIndex = Math.floor(Math.random() * currentIndex);
      currentIndex -= 1;

      // And swap it with the current element.
      temporaryValue = array[currentIndex];
      array[currentIndex] = array[randomIndex];
      array[randomIndex] = temporaryValue;
    }

    return array;
  }

  function getWhatsappLink(phone, message, current_device_type) {
    var link = ""
    var IOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    if (current_device_type == 2) {
      link = "https://web.whatsapp.com/send?text=" + message
    } else if(current_device_type == 1 && !IOS) {
      link = "whatsapp://send?text=" + message
    } else if(current_device_type == 1 && IOS) {
      link = "https://api.whatsapp.com/send?text=" + message
    }
    if(phone) {
      link += "&phone=" + phone
    }
    return link
  }

  function getMultipleAgents(settings, current_device_type, customStyle = '') {
    var multiplecs = document.createElement('div')
    multiplecs.className = "wa-chat-multiple-cs"

    if (settings.should_shuffle_agents) {
      settings.agents = shuffle(settings.agents)
    }

    for (var i = 0; i < settings.agents.length; i++) {
      if (!settings.agents[i].is_enabled) {
        continue;
      }

      if(!isAgentCurrentlyAvailable(settings.agents[i], settings.store_timezone)) {
        continue;
      }

      var agent = document.createElement('div')
      agent.className = 'list-cs'

      var agentAvatar = document.createElement('div')
      agentAvatar.innerHTML = `<img class="wa-chat-bubble-whatsapp-avatar" src="https://cdn.shopify.com/s/files/1/0070/3666/5911/files/tiny-logo.png?840"><div class="wa-chat-bubble-avatar"><img style="height: 55px; width: 55px; border-radius: 50%; ${customStyle}" class="${"avatar-theme-" + settings.greeting_template}" src="${settings.agents[i].avatar_url}"></div>`
      agent.appendChild(agentAvatar)

      var agentProfile = document.createElement('div')
      agentProfile.className = "wa-chat-bubble-cs-profile"
      agentProfile.innerHTML = '<div class="wa-chat-bubble-profile-name">' + settings.agents[i].name + '</div><p>' + settings.agents[i].role + '</p>'
      agent.appendChild(agentProfile)

      var message = getFinalWhatsappMsg(settings)
      var link = getWhatsappLink(settings.agents[i].phone, message, current_device_type)

      agent.onclick = getCustomerSuportOnClick(link, settings, settings.agents[i].id)
      multiplecs.appendChild(agent)
    }

    return multiplecs
  }

  function getTheme(settings) {
    if (settings.greeting_template == 2) {
      return "dark"
    } else {
      return "light"
    }
  }


  function playSound(url) {
    if (!document.getElementById("superlemon-iframe")) {
      var i = document.createElement('iframe')
      i.src = "https://cdn.shopify.com/s/files/1/0070/3666/5911/files/silence.mp3?1304"
      i.allow = "autoplay";
      i.id = "audio";
      i.style = "display:none";
      i.id = "superlemon-iframe"
      document.body.appendChild(i)
    }

    var a = document.createElement('audio')
    a.setAttribute("autoplay", "")
    a.innerHTML = '<source src="' + url + '" type="audio/mp3">';
  }


  function handleCalloutCard(e, settings, current_device_type) {
    if (e.target.classList.contains("wa-callout-card-close-btn") || e.target.parentNode.classList.contains("wa-callout-card-close-btn")) {
      hideCalloutCard();
    } else {
      onClick(settings, current_device_type)();
      jQuery("#wa-callout-card").hide();
    }
  }

  function hideCalloutCard() {
    var isCalloutCard = document.getElementById("wa-callout-card");
    if (isCalloutCard) {
      document.getElementById("wa-callout-card").classList.remove("animate-callout-card");
      document.getElementById("wa-callout-card").classList.add('hide-callout-card');
      setTimeout(function () {
        jQuery("#wa-callout-card").hide();
      }, 500);
    }
  }

  function showCalloutCard(settings, current_device_type, calloutCard, style, url) {
    setTimeout(function () {
      if(jQuery("#wa-chat-btn-root").is(":visible")) {
        document.body.appendChild(calloutCard);
        if (settings.is_callout_card_sound_enabled) {
          playSound(url)
        };

        let whatsAppBtnHeigth = document.getElementById("wa-chat-btn-root") ? document.getElementById("wa-chat-btn-root").clientHeight : 0;
        setTimeout(function () {
          style.innerHTML += '.animate-callout-card { bottom: ' + (getHeightOffset(current_device_type, settings) + whatsAppBtnHeigth + 12) + 'px;}';
          document.head.appendChild(style);
          calloutCard.classList.add("animate-callout-card");
        }, 400);
      }
      localStorage.setItem("callout_card_last_shown", JSON.stringify(Date.now()));
    }, (settings.callout_card_delay * 1000));
  }

  function checkCalloutCardVisibilityTiming(settings, current_device_type, calloutCard, style, url) {
    if (!localStorage.callout_card_last_shown) {
      showCalloutCard(settings, current_device_type, calloutCard, style, url);
    } else if (localStorage.callout_card_last_shown) {
      if ((Date.now() - JSON.parse(localStorage.getItem("callout_card_last_shown"))) >= (settings.callout_card_time_delay * 1000)) {
        showCalloutCard(settings, current_device_type, calloutCard, style, url);
      } else { }
    }
  }


  function loadCalloutCard(settings, current_device_type) {
    var current_device_type = deviceType();
    if ((settings.is_chat_enabled && (settings.device_type & current_device_type) != 0) && settings.agents.length > 0 && settings.agents[0].phone && settings.is_store_open && settings.is_callout_card_enabled && settings.callout_card_text) {

      let closeBtn = document.createElement('div');
      closeBtn.className = "wa-callout-card-close-btn wa-callout-card-close-btn-" + getButtonPosition(current_device_type, settings);

      closeBtn.innerHTML += '<img src="https://cdn.shopify.com/s/files/1/0070/3666/5911/files/cancel_button_final.png?1361">';

      var calloutCard = document.createElement('div');
      var callout = document.createElement('div');
      calloutCard.id = "wa-callout-card";
      callout.className = "callout-text-container";
      callout.appendChild(closeBtn);
      var p = document.createElement('p');
      p.innerText = settings.callout_card_text;
      callout.appendChild(p);
      calloutCard.appendChild(callout);

      var style = document.createElement('style');
      style.type = 'text/css';
      //zIndex from settings
      style.innerHTML = '.wa-callout-card-offset { bottom: ' + getHeightOffset(current_device_type, settings) + 'px;' + getButtonPosition(current_device_type, settings) + ':' + getHorizontalOffset(current_device_type, settings) + ';' + 'z-index:' + (current_device_type === 1 ? settings.callout_card_z_index_mobile : settings.callout_card_z_index_desktop) + ';}';
      document.head.appendChild(style);

      calloutCard.className = "wa-callout-card-fixed wa-callout-card-offset";

      calloutCard.onclick = function (e) {
        handleCalloutCard(e, settings, current_device_type)
      }

      var url = "https://cdn.shopify.com/s/files/1/0272/5983/0365/files/whatsapp_message-_AudioTrimmer.com.mp3?21";

      checkCalloutCardVisibilityTiming(settings, current_device_type, calloutCard, style, url);
    }
  }

  function loadGreetingWidget(settings, current_device_type) {
    if (jQuery("#wa-chat-bubble").length) {
      // jQuery("#wa-chat-bubble").slideToggle();
      // document.getElementById("wa-chat-bubble").style.display = "block";
      jQuery("#wa-chat-bubble").show();
      jQuery("#wa-chat-bubble").removeClass("bounceDown");
      jQuery("#wa-chat-bubble").addClass("bounceUp");
      jQuery("#wa-chat-btn-root").hide();
      return;
    }

    var root = document.createElement('div')
    root.id = "wa-chat-bubble";

    //zIndex from settings
    var style = document.createElement('style');
    style.type = 'text/css';
    style.innerHTML = '.wa-greeting-widget-z-index { z-index:' + (current_device_type === 1 ? settings.greeting_widget_z_index_mobile : settings.greeting_widget_z_index_desktop) + ';}';
    document.head.appendChild(style);
    root.className = "wa-chat-bubble-floating-popup animated wa-greeting-widget-z-index wa-chat-bubble-pos-" + getButtonPosition(current_device_type, settings) + ((settings.greeting_template > 200 && settings.greeting_template < 300) ? ' wa-intercom' : '')

    var header = document.createElement('div')
    header.className = "wa-chat-bubble-header-common wa-chat-bubble-header-" + settings.greeting_template + ((settings.greeting_template > 100 && settings.greeting_template < 200) ? ' wavy' : '');

    var avatarStyleStr = '';
    var headerStyleStr = '';
    var horizontalGradient = true;
    var bgColor1 = settings.greeting_template_bg_color_1 || '#20802C';
    var bgColor2 = settings.greeting_template_bg_color_2 || '#30BF42';
    var headTextStyle = '';
    var descTextStyle = '';

    if (settings.is_greeting_template_color_custom) {
      switch(settings.greeting_template) {
        case 301:
          break;
        case 302:
          header.className += ' wavy';
          break;
        case 303:
          horizontalGradient = false;
          root.className += ' wa-intercom';
          break;
      }

      headerStyleStr = settings.is_greeting_template_solid_background ? (`background: ${bgColor1}`) : (
        horizontalGradient ? `background-image: linear-gradient(110.56deg, ${bgColor1} 0%, ${bgColor2} 100%)` :
          `background-image: linear-gradient(164.25deg, ${bgColor1} 18.04%, ${bgColor2} 81.96%)`
      );

      header.style = headerStyleStr;
      avatarStyleStr = `background: ${bgColor1};`;
      headTextStyle = `color: ${settings.greeting_template_head_text_color || '#ffffff'}`;
      descTextStyle = `color: ${settings.greeting_template_desc_text_color || '#ffffff'}`;
    }

    header.appendChild(getCloseButton())
    header.appendChild(getHeaderTitle(settings, headTextStyle))
    header.appendChild(getHeaderDesc(settings, descTextStyle))

    // change the background then, set the agent background.
    var chat = document.createElement('div')
    chat.className = "wa-chat-bubble-chat"

    if(!settings.is_store_open) {
      var message = getStoreClosedMessage(settings);
      var div = document.createElement('div');
      div.className = "wa-chat-multiple-cs";
      var agent = document.createElement('div')
      agent.className = 'list-cs';

      var agentProfile = document.createElement('div');
      agentProfile.className = "wa-chat-bubble-cs-profile";
      agentProfile.innerHTML = '<div class="wa-chat-bubble-profile-name">' + message + '</div>';
      agent.appendChild(agentProfile);
      div.appendChild(agent);

      chat.appendChild(div);
      root.appendChild(header);
      root.appendChild(chat);
    } else if(!getOnlineAgentsCount(settings)) {
      var message = settings.offline_agent_msg || "Apologies for the inconvenience but none of our agents are online at this time. Please check after sometime."
      var div = document.createElement('div');
      div.className = "wa-chat-multiple-cs";

      var agent = document.createElement('div')
      agent.className = 'list-cs';

      var agentProfile = document.createElement('div')
      agentProfile.className = "wa-chat-bubble-cs-profile"
      agentProfile.innerHTML = '<div class="wa-chat-bubble-profile-name">' + message + '</div>'
      agent.appendChild(agentProfile);
      div.appendChild(agent)

      chat.appendChild(div)
      root.appendChild(header)
      root.appendChild(chat)
    } else {
      chat.appendChild(getMultipleAgents(settings, current_device_type, avatarStyleStr))
      root.appendChild(header)
      root.appendChild(chat)
    }

    if (settings.enable_powered_by) {
      var footer = document.createElement('div')
      footer.className = "wa-chat-widget-footer"
      footer.innerHTML = '<span style="vertical-align: middle;">Powered by <span class="wa-chat-widget-footer-superlemon">SuperLemon</span></span>'
      footer.onclick = function () {
        openInNewTab("https://apps.shopify.com/whatsapp-chat-button?utm_source=poweredby")
      }
      root.appendChild(footer)
    }

    document.body.appendChild(root)
    // jQuery("#wa-chat-bubble").hide();
    // jQuery("#wa-chat-bubble").slideToggle();

    jQuery("#wa-chat-bubble").addClass("bounceUp");
    jQuery("#wa-chat-btn-root").hide();
  }

  function getOnlineAgentsCount (settings) {
    var count = 0;
    for (var i = 0; i < settings.agents.length; i++) {
      if (!settings.agents[i].is_enabled) {
        continue;
      }

      if(!isAgentCurrentlyAvailable(settings.agents[i], settings.store_timezone)) {
        continue;
      }

      count += 1;
    }

    return count;
  }

  function getStoreClosedMessage (settings){

    const todayDay = getDay();
    let start_time,end_time;
    var store_timings = settings.store_timings.replace(/(?!\s|:)((u)(?='))/g, "");
    store_timings = store_timings.replace(/\'/g, '"');
    var store_timings = JSON.parse(store_timings);
  
    // get today's shop time
    for(const obj of store_timings)
    {
      if(obj.day === todayDay)
      {
        start_time = obj.start_time;
        end_time = obj.end_time;
      }
    }
    
    start_time = start_time.substring(0,2) + ":" + start_time.substring(2,4);
    end_time = end_time.substring(0,2) + ":" + end_time.substring(2,4);
  
    var message = settings.offline_store_msg || "Hi, our working hours are <start_time> to <end_time>, request you to reach us at the same time. Apologies for the inconvenience.";
    message = message.replace("<start_time>",start_time);
    message = message.replace("<end_time>",end_time);
  
    return message;
  }

  function getDay(){
    const dayMap = {
      0:"Sunday",
      1:"Monday",
      2:"Tuesday",
      3:"Wednesday",
      4:"Thursday",
      5:"Friday",
      6:"Saturday"
    }
    const date = new Date().getDay();
    return dayMap[date];
  }

  function onClick(settings, current_device_type) {
    return function () {
      hideCalloutCard()
      if (settings.is_multi_agent_enabled) {
        loadGreetingWidget(settings, current_device_type)
      } else {
        if(!getOnlineAgentsCount(settings)) {
          var message = settings.offline_agent_msg ? settings.offline_agent_msg : "Apologies for the inconvenience but none of our agents are online at this time. Please check after sometime.";
          alert(message);
        } else if(!settings.is_store_open) {
          var message = getStoreClosedMessage(settings)
          alert(message);
        } else {
          var message = getFinalWhatsappMsg(settings)
          var available_agent = getFirstAvailableAgent(settings)
          var link = getWhatsappLink(available_agent.phone, message, current_device_type)

          onChatInitiated(settings, null)
          openInNewTab(link);
        }
      }
    }
  }

  function isThankYouPage() {
    if (window.location.pathname.match("(.*)/orders/(.*)") || window.location.pathname.match("(.*)/checkouts/(.*)")) {
      return true
    } else {
      return false
    }
  }

  function isProductPage() {
    if (window.location.pathname.match("(.*)/products/(.*)")) {
      return true
    } else {
      return false
    }
  }


  function isCollectionsPage() {
    if ((window.location.pathname.match("(.*)/collections/(.*)") || window.location.pathname.match("(.*)/collections")) && !(window.location.pathname.match("(.*)/products/(.*)") || window.location.pathname.match("(.*)/products"))) {
      return true
    } else {
      return false
    }
  }

  function isShareBtnVisible(settings) {
    if (window.location.pathname === "/" && !settings.show_share_btn_on_home_page) {
      return false;
    } else if (isCollectionsPage() && !settings.show_share_btn_on_collections_page) {
      return false;
    } else if ((window.location.pathname.match("(.*)/products/(.*)") || window.location.pathname.match("(.*)/products")) && !settings.show_share_btn_on_product_page) {
      return false;
    } else if ((window.location.pathname.match("(.*)/cart/(.*)") || window.location.pathname.match("(.*)/cart")) && !settings.show_share_btn_on_cart_page) {
      return false;
    } else if ((window.location.pathname.match("(.*)/orders/(.*)") || window.location.pathname.match("(.*)/orders") || window.location.pathname.match("(.*)/checkouts/(.*)")) && !settings.show_share_btn_on_thank_you_page) {
      return false;
    } else if ((window.location.pathname.match("(.*)/blogs/(.*)") || window.location.pathname.match("(.*)/blogs")) && !settings.show_share_btn_on_blog_post_page) {
      return false;
    } else if ((window.location.pathname.match("(.*)/pages/(.*)") || window.location.pathname.match("(.*)/pages")) && !settings.show_share_btn_on_pages_page) {
      return false;
    } else if ((window.location.pathname.match("(.*)/account/(.*)") || window.location.pathname.match("(.*)/account")) && !settings.show_share_btn_on_account_page) {
      return false;
    } else {
      return true;
    }
  }

  const weekday = {
    Sun: 6,
    Mon: 0,
    Tue: 1,
    Wed: 2,
    Thu: 3,
    Fri: 4,
    Sat: 5,
  };
  function isAgentCurrentlyAvailable(agent, store_timezone = "UTC") {
    // options for intl object
    options = {
      weekday: "short",
      hour: "numeric",
      minute: "numeric",
      second: "numeric",
      hour12: false,
      timeZone: store_timezone,
    };
    // get intl string with options
    const intlObj = new Intl.DateTimeFormat("en-US", options).format(new Date()).trim();
    // get weekday name and time from intlObj
    const dateObjSplit = intlObj.split(" ");
    // get week day index
    const currentDayIndex = weekday[dateObjSplit[0]];
    // get current hours and minutes
    const time = dateObjSplit[1].split(":");
    const hours = parseInt(time[0]);
    const minutes = parseInt(time[1]);
    
    var currentHourMinutes = hours * 60 + minutes;
    var startHourMinutes = parseInt(agent.store_timings[currentDayIndex].start_time.substring(0, 2)) * 60 
      + parseInt(agent.store_timings[currentDayIndex].start_time.substring(2, 4));
    var endHourMinutes = parseInt(agent.store_timings[currentDayIndex].end_time.substring(0, 2)) * 60 
      + parseInt(agent.store_timings[currentDayIndex].end_time.substring(2, 4));
    
    return (
      startHourMinutes <= currentHourMinutes &&
      endHourMinutes >= currentHourMinutes
    );
  }

  function getFirstAvailableAgent(settings) {
    for (var i = 0; i < settings.agents.length; i++) {
      if(isAgentCurrentlyAvailable(settings.agents[i], settings.store_timezone) && settings.agents[i].is_enabled) {
        return settings.agents[i]
      }
    }
    return null
  }

  function isAtleastOneAgentAvailable(settings) {
    for (var i = 0; i < settings.agents.length; i++) {
      if(isAgentCurrentlyAvailable(settings.agents[i], settings.store_timezone)) {
        return true;
      }
    }

    return false;
  }

  function isWhatsAppBtnVisible(settings) {
    if (window.location.pathname === "/" && !settings.show_whatsApp_chat_btn_on_home_page) {
      return false;
    } else if (isCollectionsPage() && !settings.show_whatsApp_chat_btn_on_collections_page) {
      return false;
    } else if ((window.location.pathname.match("(.*)/products/(.*)") || window.location.pathname.match("(.*)/products")) && !settings.show_whatsApp_chat_btn_on_product_page) {
      return false;
    } else if ((window.location.pathname.match("(.*)/cart/(.*)") || window.location.pathname.match("(.*)/cart")) && !((deviceType() === 2 && settings.show_whatsApp_chat_btn_on_cart_page) || (deviceType() === 1 && settings.show_whatsApp_chat_btn_on_minicart_page))) {
      return false;
    } else if ((window.location.pathname.match("(.*)/orders/(.*)") || window.location.pathname.match("(.*)/orders") || window.location.pathname.match("(.*)/checkouts/(.*)")) && !settings.show_whatsApp_chat_btn_on_thank_you_page) {
      return false;
    } else if ((window.location.pathname.match("(.*)/blogs/(.*)") || window.location.pathname.match("(.*)/blogs")) && !settings.show_whatsApp_chat_btn_on_blog_post_page) {
      return false;
    } else if ((window.location.pathname.match("(.*)/pages/(.*)") || window.location.pathname.match("(.*)/pages")) && !settings.show_whatsApp_chat_btn_on_pages_page) {
      return false;
    } else if ((window.location.pathname.match("(.*)/account/(.*)") || window.location.pathname.match("(.*)/account")) && !settings.show_whatsApp_chat_btn_on_account_page) {
      return false;
    } else {
      return true;
    }
  }

  function getShareButtonTheme(template_id) {
    switch (template_id) {
      case 1:
        return "wa-share-btn-tmpl-regular"
      case 2:
        return "wa-share-btn-tmpl-inverted"
      case 3:
        return "wa-share-btn-tmpl-black-regular"
      case 4:
        return "wa-share-btn-tmpl-black-inverted"
      case 5:
        return "wa-share-btn-tmpl-old"
    }
  }

  function getShareButtonImg(template_id) {
    switch (template_id) {
      case 1:
        return "https://cdn.shopify.com/s/files/1/0070/3666/5911/files/new_logo_1_0226a498-7303-4b41-a78c-cc5d9c1db062.png?463"
      case 2:
        return "https://cdn.shopify.com/s/files/1/0070/3666/5911/files/image_2.6.png?463"
      case 3:
        return "https://cdn.shopify.com/s/files/1/0070/3666/5911/files/112_2.png?825"
      case 4:
        return "https://cdn.shopify.com/s/files/1/0070/3666/5911/files/113.png?819"
      case 5:
        return "https://cdn.shopify.com/s/files/1/0070/3666/5911/files/image_6.4.png?816"
      default:
        return "https://cdn.shopify.com/s/files/1/0070/3666/5911/files/Group.svg?v=1583716483"
    }
  }

  function getOptinWidgetLogoImg(widget_language) {
    switch (widget_language) {
      case 1:
        if (mobilecheck()) {
          return "https://cdn.shopify.com/s/files/1/0070/3666/5911/files/optin-eng-mobile.png"
        } else {
          return "https://cdn.shopify.com/s/files/1/0070/3666/5911/files/optin-eng-desktop.png"
        }
      case 2:
        if (mobilecheck()) {
          return "https://cdn.shopify.com/s/files/1/0070/3666/5911/files/optin-por-mobile.png"
        } else {
          return "https://cdn.shopify.com/s/files/1/0070/3666/5911/files/optin-por-desktop-s.png?1306"
        }
      case 3:
        if (mobilecheck()) {
          return "https://cdn.shopify.com/s/files/1/0070/3666/5911/files/optin-spa-mobile.png"
        } else {
          return "https://cdn.shopify.com/s/files/1/0070/3666/5911/files/optin-spa-desktop-s.png?1306"
        }
      case 4:
        if (mobilecheck()) {
          return "https://cdn.shopify.com/s/files/1/0070/3666/5911/files/optin-ita-mobile.png?1538"
        } else {
          return "https://cdn.shopify.com/s/files/1/0070/3666/5911/files/optin-ita-desktop.png?1538"
        }
      default:
        if (mobilecheck()) {
          return "https://cdn.shopify.com/s/files/1/0070/3666/5911/files/optin-eng-mobile.png"
        } else {
          return "https://cdn.shopify.com/s/files/1/0070/3666/5911/files/optin-eng-desktop.png"
        }
    }
  }

  function getConfirmBtnText(widget_language) {
    switch (widget_language) {
      case 1:
        return "CONFIRM"
      case 2:
        return "CONFIRME"
      case 3:
        return "CONFIRMAR"
      case 4:
        return "CONFERMARE"
      case 5:
        return "CONFIRMER"
      case 6:
        return "KONFIRMASI"
      case 7:
        return "BESTÄTIGEN"
      case 8:
        return "إرسال"
      case 9:
        return "ONAYLAMAK"
      case 10:
        return "אישור"
      case 11:
        return "BEVESTIGEN"
    }
  }

  // ===========================================================
  // optin widget title/list items text fn
  // ===========================================================

  function getOrderText(widget_language) {
    switch (widget_language) {
      case 1:
        return "Order details";
      case 2:
        return "Detalhes do pedido";
      case 3:
        return "Detalles del pedido";
      case 4:
        return "Dettagli dell'ordine"
      case 5:
        return "Détails de la commande"
      case 6:
        return "Rincian pesanan"
      case 7:
        return "Bestelldetails"
      case 8:
        return "تفاصيل الطلب"
      case 9:
        return "Sipariş detayları"
      case 10:
        return "פרטי הזמנה"
      case 11:
        return "Bestel Details"
      default:
        return "";
    }
  }

  function getDeliveryText(widget_language) {
    switch (widget_language) {
      case 1:
        return "Delivery updates";
      case 2:
        return "Atualizações de entrega";
      case 3:
        return "Actualizaciones de entrega";
      case 4:
        return "Aggiornamenti di consegna"
      case 5:
        return "Mises à jour de livraison"
      case 6:
        return "Informasi pengiriman"
      case 7:
        return "Lieferaktualisierungen"
      case 8:
        return "تحديثات التسليم"
      case 9:
        return "Gönderim güncellemeleri"
      case 10:
        return "עדכוני משלוח"
      case 11:
        return "Levering updates"
      default:
        return "";
    }
  }

  function getCustomerSupportText(widget_language) {
    switch (widget_language) {
      case 1:
        return "Customer support";
      case 2:
        return "Suporte ao cliente";
      case 3:
        return "Atención al cliente";
      case 4:
        return "Servizio Clienti"
      case 5:
        return "Service client"
      case 6:
        return "Dukungan pelanggan"
      case 7:
        return "Kundendienst"
      case 8:
        return "دعم العملاء"
      case 9:
        return "Müşteri desteği"
      case 10:
        return "שירות לקוחות"
      case 11:
        return "Klantenservice"
      default:
        return "";
    }
  }


  function getConfirmedBtnText(widget_language) {
    switch (widget_language) {
      case 1:
        return "Confirmed!"
      case 2:
        return "Confirmado!"
      case 3:
        return "¡Confirmado!"
      case 4:
        return "Confermata!"
      case 5:
        return "Confirmé!"
      case 6:
        return "Dikonfirmasi!"
      case 7:
        return "Bestätigt!"
      case 8:
        return "تم تأكيد!"
      case 9:
        return "Onaylanmış!"
      case 10:
        return "אושר!"
      case 11:
        return "Bevestigd!"
    }
  }

  function getOptinWidgetTitleText(widget_language) {
    switch (widget_language) {
      case 1:
        return `<p class="wa-optin-widget-title">
          <span class="wa-optin-widget-title-text">Receive updates on </span>
          <br/>
          <span class="wa-optin-widget-title-text"><img class="wa-optin-widget-title-text-logo" src="https://cdn.shopify.com/s/files/1/0070/3666/5911/files/whatsapp-logo-large.png?1435" alt="whatsapp logo" />WhatsApp
          </span>
        </p>`;

      case 2:
        return `<p class="wa-optin-widget-title">
          <span class="title-text">Receba atualizações</span>
          <br/>
          <span class="wa-optin-widget-title-text">no<img class="wa-optin-widget-title-text-logo" src="https://cdn.shopify.com/s/files/1/0070/3666/5911/files/whatsapp-logo-large.png?1435" alt="whatsapp logo" />WhatsApp</span>
        </p>`;

      case 3:
        return `<p class="wa-optin-widget-title">
          <span class="wa-optin-widget-title-text">Recibe actualizaciones</span>
          <br/>
          <span class="wa-optin-widget-title-text">en<img class="wa-optin-widget-title-text-logo" src="https://cdn.shopify.com/s/files/1/0070/3666/5911/files/whatsapp-logo-large.png?1435" alt="whatsapp logo" />WhatsApp</span>
        </p>`;

      case 4:
        return `<p class="wa-optin-widget-title">
          <span class="wa-optin-widget-title-text">Ricevi aggiornamenti</span>
          <br/>
          <span class="wa-optin-widget-title-text">su<img class="wa-optin-widget-title-text-logo" src="https://cdn.shopify.com/s/files/1/0070/3666/5911/files/whatsapp-logo-large.png?1435" alt="whatsapp logo" />WhatsApp</span>
        </p>`;

      case 5:
        return `<p class="wa-optin-widget-title">
          <span class="wa-optin-widget-title-text">Recevez des mises à</span>
          <br/>
          <span class="wa-optin-widget-title-text">jour<img class="wa-optin-widget-title-text-logo" src="https://cdn.shopify.com/s/files/1/0070/3666/5911/files/whatsapp-logo-large.png?1435" alt="whatsapp logo" />WhatsApp</span>
        </p>`;

      case 6:
        return `<p class="wa-optin-widget-title">
          <span class="wa-optin-widget-title-text">Terima informasi</span>
          <br/>
          <span class="wa-optin-widget-title-text">di<img class="wa-optin-widget-title-text-logo" src="https://cdn.shopify.com/s/files/1/0070/3666/5911/files/whatsapp-logo-large.png?1435" alt="whatsapp logo" />WhatsApp</span>
        </p>`;

      case 7:
        return `<p class="wa-optin-widget-title">
          <span class="wa-optin-widget-title-text">Erhalte Updates</span>
          <br/>
          <span class="wa-optin-widget-title-text">über<img class="wa-optin-widget-title-text-logo" src="https://cdn.shopify.com/s/files/1/0070/3666/5911/files/whatsapp-logo-large.png?1435" alt="whatsapp logo" />WhatsApp</span>
        </p>`;

      case 8:
        return `<p class="wa-optin-widget-title">
          <span class="wa-optin-widget-title-text">تلقي التحديثات على</span>
          <br/>
          <span class="wa-optin-widget-title-text"><img class="wa-optin-widget-title-text-logo" src="https://cdn.shopify.com/s/files/1/0070/3666/5911/files/whatsapp-logo-large.png?1435" alt="whatsapp logo" />WhatsApp</span>
        </p>`;

      case 9:
        return `<p class="wa-optin-widget-title">
          <span class="wa-optin-widget-title-text">Güncellemeleri buradan</span>
          <br/>
          <span class="wa-optin-widget-title-text">al<img class="wa-optin-widget-title-text-logo" src="https://cdn.shopify.com/s/files/1/0070/3666/5911/files/whatsapp-logo-large.png?1435" alt="whatsapp logo" />WhatsApp</span>
        </p>`;

      case 10:
        return `<p class="wa-optin-widget-title">
          <span class="wa-optin-widget-title-text">קבל עדכונים דרך</span>
          <br/>
          <span class="wa-optin-widget-title-text"><img class="wa-optin-widget-title-text-logo" src="https://cdn.shopify.com/s/files/1/0070/3666/5911/files/whatsapp-logo-large.png?1435" alt="whatsapp logo" />WhatsApp</span>
        </p>`;

      case 11:
        return `<p class="wa-optin-widget-title">
          <span class="wa-optin-widget-title-text">Ontvang updates</span>
          <br/>
          <span class="wa-optin-widget-title-text">op<img class="wa-optin-widget-title-text-logo" src="https://cdn.shopify.com/s/files/1/0070/3666/5911/files/whatsapp-logo-large.png?1435" alt="whatsapp logo" />WhatsApp</span>
        </p>`;

      default:
        return "";
    }
  }


  function loadOldOptinWidget(settings) {
    jQuery('#wa-optin-widget-root-old').remove()

    if (localStorage.getItem("opted_in_phone_v2")) {
      return
    }

    if (localStorage.getItem("dismiss_count") > 1) {
      return
    }
    let current_device_type = deviceType();
    var widgetContainer = document.createElement('div')
    widgetContainer.id = "wa-optin-widget-root-old"

    //zIndex from settings
    var style = document.createElement('style');
    style.type = 'text/css';
    style.innerHTML = '.wa-optin-widget-z-index-old { z-index:' + (current_device_type === 1 ? settings.chatsetting.optin_widget_z_index_mobile : settings.chatsetting.optin_widget_z_index_desktop) + ';}';
    document.head.appendChild(style);

    widgetContainer.className = "wa-optin-widget-container-old wa-optin-widget-z-index-old";

    var closeBtn = document.createElement('div')
    closeBtn.className = "wa-optin-widget-close-btn-old"
    closeBtn.onclick = function () {
      var dismiss_count = localStorage.getItem("dismiss_count")
      localStorage.setItem("dismiss_count", (parseInt(dismiss_count) ? parseInt(dismiss_count) + 1 : 1))
      jQuery('#wa-optin-widget-root-old').remove()
    }

    var closeImg = document.createElement('img')
    closeImg.className = "wa-optin-widget-close-img-old"
    closeImg.src = "https://cdn.shopify.com/s/files/1/0070/3666/5911/files/Group_2.png?1194"

    closeBtn.appendChild(closeImg)

    var contentContainer = document.createElement('div')
    contentContainer.className = "wa-optin-widget-content-container-old"

    var logoImg = document.createElement('img')
    logoImg.className = "wa-optin-widget-logo-img-old"
    logoImg.src = getOptinWidgetLogoImg(settings.widget_language)

    var numberContainer = document.createElement('div')
    numberContainer.style = "text-align: center"


    var numberInput = document.createElement('input')
    numberInput.className = "wa-optin-widget-number-input-old"
    numberInput.placeholder = "+91  XXXXXXXXXX"
    numberInput.id = "wa-optin-phone-number-old"
    numberInput.type = "tel"

    var confirmButton = document.createElement('button')
    confirmButton.className = 'wa-optin-widget-confirm-button-old'
    confirmButton.innerHTML = getConfirmBtnText(settings.widget_language)
    confirmButton.onclick = function () {
      var phone = jQuery("#wa-optin-phone-number-old").val()
      jQuery('#wa-optin-widget-root-old').remove()

      if (phone) {
        localStorage.setItem("opted_in_phone_v2", phone)
        jQuery.ajax({
          url: SERVER_BASE_URL + '/shop/order/optin/v2',
          type: 'POST',
          dataType: 'json',
          contentType: 'application/json',
          data: JSON.stringify({ "shop_id": getShopId(), "phone": phone })
        });
      }
    }

    numberContainer.appendChild(numberInput)
    numberContainer.appendChild(confirmButton)

    contentContainer.appendChild(logoImg)
    contentContainer.appendChild(numberContainer)

    widgetContainer.appendChild(closeBtn)
    widgetContainer.appendChild(contentContainer)


    document.body.appendChild(widgetContainer)
    document.getElementById("wa-optin-phone-number-old").addEventListener('focus', (e) => { if (e.relatedTarget) { e.relatedTarget.removeAttribute('tabindex'); e.target.focus(); } return false; })
    jQuery("#wa-optin-phone-number-old").focus()

    if (localStorage.getItem("calling_code")) {
      jQuery("#wa-optin-phone-number-old").val("+" + localStorage.getItem("calling_code") + "  ");
      jQuery("#wa-optin-phone-number-old").focus()
    } else {
      jQuery.get(SERVER_BASE_URL + "/shop/ipinfo?shop_id=" + getShopId(), function (response) {
        if (response && response.calling_code) {
          jQuery("#wa-optin-phone-number-old").val("+" + response.calling_code + "  ");
          jQuery("#wa-optin-phone-number-old").focus()
          localStorage.setItem("calling_code", response.calling_code)
          localStorage.setItem("emoji_flag", response.emoji_flag);
        }
      }, "jsonp");
    }
  }

  function createOldOptinWidget(settings) {
    if (settings.enable_optin) {
      if (isThankYouPage()) {
        if (localStorage.getItem("opted_in_phone_v2")) {
          if (Shopify.checkout.order_id) {
            jQuery.ajax({
              url: SERVER_BASE_URL + '/shop/order/optin/v2',
              type: 'POST',
              dataType: 'json',
              contentType: 'application/json',
              data: JSON.stringify({
                "shop_id": getShopId(),
                "phone": localStorage.getItem("opted_in_phone_v2"),
                order_id: Shopify.checkout.order_id
              })
            });
          }
          loadOptinConfirmed(settings.widget_language)
        } else {
          thankYouPageOptinWidget(settings.widget_language)
        }

      } else {
        jQuery("form[action^='/cart']").on("submit", function () {
          loadOldOptinWidget(settings)
        })
        jQuery("form[action^='/cart']").find("button").on("click", function () {
          loadOldOptinWidget(settings)
        })
        jQuery("form[action^='/cart/add']").find("button").on("click", function () {
          loadOldOptinWidget(settings)
        })
        jQuery("#add-to-cart").on("click", function () {
          loadOldOptinWidget(settings)
        })
        if (top.location.href.indexOf("/cart") > 0) {
          loadOldOptinWidget(settings)
        }
      }
    }
  }

  function getLastLocalOptinFromThankyouPage() {
      var unique_identifier = ((Shopify.checkout.email || '') + (Shopify.checkout.phone || '')).replace(" ","")
      if(!localStorage.getItem("previous_thank_you_page_optin") && localStorage.getItem("opted_in_phone_v2")) {
        return localStorage.getItem("opted_in_phone_v2")
      } else if(localStorage.getItem("previous_thank_you_page_optin")){
        previous_optin_obj = JSON.parse(localStorage.getItem("previous_thank_you_page_optin"))
        if(previous_optin_obj.unique_identifier == unique_identifier) {
          return previous_optin_obj.phone_number
        }
      }
      return null
  }

  function customOptinFromThankYouPage(phone) {
    var unique_identifier = ((Shopify.checkout.email || '') + (Shopify.checkout.phone || '')).replace(" ","")
    localStorage.setItem("opted_in_phone_v2", phone)
    localStorage.setItem("previous_thank_you_page_optin", JSON.stringify({
      "unique_identifier": unique_identifier,
      "phone_number": phone
    }))
    jQuery('#wa-order-update-widget').remove()
    jQuery.ajax({
      url: SERVER_BASE_URL + '/shop/order/optin/v2',
      type: 'POST',
      dataType: 'json',
      contentType: 'application/json',
      data: JSON.stringify({
        "shop_id": getShopId(),
        "phone": phone,
        order_id: Shopify.checkout.order_id
      })
    });
  }

  function runThankyouPageLogic(settings, retry=5) {
    return function(){
      jQuery.ajax({
        url: SERVER_BASE_URL + '/shop/order/phone/confirmed/status?shop_id=' + getShopId() + '&order_id=' + Shopify.checkout.order_id,
        type: 'GET',
        success: function (order_phone_confirmed_status) {
          switch(order_phone_confirmed_status.status) {
            case "not_found":
            last_local_storage_optin = getLastLocalOptinFromThankyouPage()
            if(last_local_storage_optin) {
                customOptinFromThankYouPage(last_local_storage_optin)
                loadOptinConfirmed(settings.widget_language, last_local_storage_optin)
            } else {
                thankYouPageOptinWidget(settings.widget_language)
            }
            return
            case "confirmed":
            loadOptinConfirmed(settings.widget_language, order_phone_confirmed_status.phone)
            return
            case "in_progress":
            if(retry > 0) {
              setTimeout(runThankyouPageLogic(settings, retry-1), 500)
            }
            return
            default:
            return
          }
        },
      });
    }
  }

  function createOptinWidget(settings, originalViewportSize) {
    if (settings.enable_optin) {
      if (isThankYouPage() && settings.show_optin_on_thank_you_page) {
        runThankyouPageLogic(settings)()
      } else if (settings.enable_optin_on_store_front) {
        if (settings.show_optin_on_checkout) {
          loadOptinWidgetOnCheckout(settings, originalViewportSize)
        }

        if (settings.show_optin_on_buy_now) {
          loadOptinWidgetOnBuyNow(settings, originalViewportSize)
        }

        if (settings.show_optin_on_add_to_cart) {
          loadOptinWidgetOnAddToCart(settings, originalViewportSize)
        }

        if (settings.show_optin_on_landing_cart_page && top.location.href.indexOf("/cart") > 0) {
          loadOptinWidget(settings, originalViewportSize, function () { })
        }
      }
    }
  }

  function shrinkMobileOptinWidget() {
    if (document.querySelector(".wa-optin-widget-ul-container")) {
      document.querySelector(".wa-optin-widget-ul-container").style.display = "none";
      document.querySelector(".wa-optin-widget-right-sec").classList.add("wa-optin-widget-virtual-keyboard-right-sec-margin-top");
      document.querySelector(".wa-optin-widget-confirm-btn").classList.add("wa-optin-widget-virtual-keyboard-confirm-btn-margin");
    }
  }

  function restoreMobileOptinWidgetSize() {
    if (document.querySelector(".wa-optin-widget-ul-container")) {
      document.querySelector(".wa-optin-widget-ul-container").style.display = "flex";
      document.querySelector(".wa-optin-widget-right-sec").style.marginTop = "0";
      document.querySelector(".wa-optin-widget-right-sec").classList.remove("wa-optin-widget-virtual-keyboard-right-sec-margin-top");
      document.querySelector(".wa-optin-widget-confirm-btn").classList.remove("wa-optin-widget-virtual-keyboard-confirm-btn-margin");
    }
  }

  function removeOptinWidget() {
    jQuery('#wa-optin-widget-main').fadeOut(600, "linear");
    setTimeout(function () {
      jQuery('body').removeClass("wa-optin-widget-stop-scrolling");
      jQuery('#wa-optin-widget-main').remove();
    }, 200)
  }

  function getTargetAhrefFromEvent(target) {
      if(!target) {
        return null
      } else if (target.tagName == "A") {
        return target
      } else if (jQuery(target).closest("a")) {
        return jQuery(target).closest("a")[0]
      }
  }

  function getTargetButtonFromEvent(target) {
    if (!target) {
      return null
    } else if (target.tagName == "BUTTON") {
      return target
    } else if (jQuery(target).closest('button')) {
      return jQuery(target).closest('button')[0]
    } else {
      return null
    }
  }

  function loadOptinWidgetOnAddToCart(settings, originalViewportSize) {
    var secondClick = false
    document.body.addEventListener('click', function (e) {
      const add_to_cart_target = getTargetButtonFromEvent(e.target)
      const closest_form = jQuery(add_to_cart_target).closest('form')
      if (add_to_cart_target && add_to_cart_target.getAttribute('data-testid') != 'Checkout-button' && closest_form && closest_form.attr('action') == "/cart/add") {
        if (!secondClick) {
          e.stopPropagation()
          e.preventDefault()
          loadOptinWidget(settings, originalViewportSize, function () {
            secondClick = true
            e.target.click()
          })
        } else {
          secondClick = false
        }

      }
    }, true);
  }

  function loadOptinWidgetOnCheckout(settings, originalViewportSize) {
    var secondClick = false

    document.body.addEventListener('click', function (e) {
      const checkout_btn = getTargetButtonFromEvent(e.target)
      const checkout_ahref = getTargetAhrefFromEvent(e.target)
      const closest_form = checkout_btn && checkout_btn.getAttribute("type") == "submit" ? jQuery(checkout_btn).closest('form') : null

      if ((checkout_btn && (checkout_btn.getAttribute('name') == 'checkout' || checkout_btn.getAttribute('onclick') == "window.location='/checkout'")) ||
        (e.target && e.target.name == 'checkout' && e.target.tagName == "INPUT") ||
        (checkout_ahref && checkout_ahref.getAttribute("href") == "/checkout") ||
        (closest_form && closest_form.attr("action") == "/checkout")) {
        if (!secondClick) {
          e.stopPropagation()
          e.preventDefault()
          loadOptinWidget(settings, originalViewportSize, function () {
            secondClick = true
            e.target.click()
          })
        } else {
          secondClick = false
        }

      }
    }, true)
  }

  function loadOptinWidgetOnBuyNow(settings, originalViewportSize) {
    var secondClick = false

    document.body.addEventListener('click', function (e) {
      const buy_now_target = getTargetButtonFromEvent(e.target)
      if (buy_now_target && buy_now_target.getAttribute('data-testid') && buy_now_target.getAttribute('data-testid') == 'Checkout-button') {
        if (!secondClick) {
          e.preventDefault()
          e.stopPropagation()
          loadOptinWidget(settings, originalViewportSize, function () {
            secondClick = true
            buy_now_target.click()
          })
        } else {
          secondClick = false
        }

      }
    }, true)
  }

  // ==================================================
  // new optin widget
  // ==================================================
  function loadOptinWidget(settings, originalViewportSize, onDismiss) {
    jQuery('body').removeClass("wa-optin-widget-stop-scrolling");
    jQuery('#wa-optin-widget-main').remove();

    let current_device_type = deviceType();

    if ((current_device_type & settings.optin_widget_device_type) === 0) {
      setTimeout(onDismiss, 200)
      return
    }

    if ((Date.now() - JSON.parse(localStorage.getItem("optin_widget_last_shown"))) < (settings.delay_between_each_optin_widget_show * 1000)) {
      setTimeout(onDismiss, 200)
      return
    }

    if (localStorage.getItem("opted_in_phone_v2")) {
      setTimeout(onDismiss, 200)
      return
    }

    if (localStorage.getItem("dismiss_count") > 1 && ((Date.now() - JSON.parse(localStorage.getItem("optin_widget_last_dismissed"))) < (settings.delay_after_optin_widget_dismissed * 1000))) {
      setTimeout(onDismiss, 200)
      return
    } else if (localStorage.getItem("dismiss_count") > 1 && ((Date.now() - JSON.parse(localStorage.getItem("optin_widget_last_dismissed"))) >= (settings.delay_after_optin_widget_dismissed * 1000))) {
      localStorage.removeItem("dismiss_count")
    }

    var widgetContainer = document.createElement('div')
    var blurContainer = document.createElement("div");
    blurContainer.className = "wa-blur-container wa-optin-widget-z-index";
    blurContainer.id = "wa-optin-widget-main";
    document.body.appendChild(blurContainer)
    jQuery(blurContainer).hide()

    //zIndex from settings
    var style = document.createElement('style');
    style.type = 'text/css';
    style.innerHTML = '.wa-optin-widget-z-index { z-index:' + (current_device_type === 1 ? settings.chatsetting.optin_widget_z_index_mobile : settings.chatsetting.optin_widget_z_index_desktop) + ';}';
    document.head.appendChild(style);

    widgetContainer.className = "wa-optin-widget-container wa-optin-widget-z-index";

    if (window.getComputedStyle(document.body).direction == 'rtl' && mobilecheck()) {
      widgetContainer.style.transform = "translate(-12.5%, -50%)"
    } else if(window.getComputedStyle(document.body).direction == 'rtl') {
      widgetContainer.style.transform = "translate(-25%, -50%)"
    }

    var closeBtn = document.createElement('div')
    closeBtn.className = "wa-optin-widget-close-btn";

    var closeImg = document.createElement('img');
    closeImg.className = "wa-optin-widget-close-img";
    closeImg.src = "https://cdn.shopify.com/s/files/1/0272/5983/0365/files/Vector_4.png?36"

    closeBtn.appendChild(closeImg);

    closeBtn.onclick = function (e) {
      var dismiss_count = localStorage.getItem("dismiss_count");
      localStorage.setItem("dismiss_count", (parseInt(dismiss_count) ? parseInt(dismiss_count) + 1 : 1));
      localStorage.setItem("optin_widget_last_dismissed", JSON.stringify(Date.now()));
      removeOptinWidget()
      onDismiss()
    }

    var contentContainer = document.createElement('div')
    contentContainer.className = "wa-optin-widget-content-container"

    var leftSec = document.createElement("div");
    var rightSec = document.createElement("div");

    var title = document.createElement("div");
    title.className = "wa-optin-widget-title-container";
    title.innerHTML = getOptinWidgetTitleText(settings.widget_language);

    var ulContainer = document.createElement("div");
    ulContainer.className = "wa-optin-widget-ul-container";

    ulContainer.innerHTML =
      `<ul class="wa-optin-widget-ul">
      <li class="wa-optin-widget-list-items">
        <img src="https://cdn.shopify.com/s/files/1/0070/3666/5911/files/Group_27.png?1401" alt="check icon" />
        <span> ${getOrderText(settings.widget_language)}</span>
      </li>
      <li class="wa-optin-widget-list-items">
        <img src="https://cdn.shopify.com/s/files/1/0070/3666/5911/files/Group_27.png?1401" alt="check icon" />
        <span> ${getDeliveryText(settings.widget_language)}</span>
      </li>
      <li class="wa-optin-widget-list-items">
        <img src="https://cdn.shopify.com/s/files/1/0070/3666/5911/files/Group_27.png?1401" alt="check icon" />
        <span> ${getCustomerSupportText(settings.widget_language)}</span>
      </li>
    </ul>`;

    leftSec.appendChild(title);
    leftSec.appendChild(ulContainer);

    var rightSecTxtCont = document.createElement("div");
    rightSecTxtCont.className = "wa-optin-widget-right-sec-content-container";

    var inputBox = document.createElement("div");
    inputBox.className = "wa-optin-widget-input-box";

    //flag imoji
    var countryLogo = document.createElement("span");
    countryLogo.className = "wa-optin-widget-country-flag"
    countryLogo.id = "wa-splmn-country-flag-logo"

    var buttonConfirm = document.createElement("button");
    buttonConfirm.innerText = getConfirmBtnText(settings.widget_language);
    buttonConfirm.className = "wa-optin-widget-confirm-btn";
    buttonConfirm.id = "wa-optin-widget-confirm-btn";

    var bgContainer = document.createElement("div");
    bgContainer.className = "wa-optin-widget-title-bg-container";

    leftSec.className = "wa-optin-widget-left-sec";
    rightSec.className = "wa-optin-widget-right-sec";

    var textContent = document.createElement("div");
    var inputContainer = document.createElement('div');
    inputContainer.className = "wa-input-container";
    var numberInput = document.createElement('input');
    // numberInput.className = "wa-optin-widget-number-input input"
    numberInput.className = "wa-optin-widget-input";
    numberInput.placeholder = "+XXX XXXXXXXXX"
    numberInput.id = "wa-optin-phone-number";
    numberInput.autocomplete = "off";
    numberInput.type = "tel"

    numberInput.addEventListener("keydown", (e) => {
      var confirmBtn = document.getElementById("wa-optin-widget-confirm-btn");
      if (e.target.value.length >= 1) {
        if (confirmBtn) {
          confirmBtn.classList.add("wa-optin-widget-confirm-btn-active")
        };
      } else if (!e.target.value.trim()) {
        if (confirmBtn) {
          confirmBtn.classList.remove("wa-optin-widget-confirm-btn-active")
        };
      }
    })

    inputBox.appendChild(countryLogo);
    inputBox.appendChild(numberInput);

    rightSecTxtCont.appendChild(inputBox);
    rightSecTxtCont.appendChild(buttonConfirm);

    rightSec.appendChild(rightSecTxtCont);
    contentContainer.appendChild(closeBtn);
    contentContainer.appendChild(bgContainer);

    contentContainer.appendChild(leftSec);
    contentContainer.appendChild(rightSec);


    numberInput.onblur = () => {
      if (mobilecheck()) {
        setTimeout(function () {
          restoreMobileOptinWidgetSize()
        }, 200)
      }
    }

    window.onresize = function () {
      if (mobilecheck() && jQuery(window).width() + jQuery(window).height() == originalViewportSize) {
        // this means keyboard is not visible
        restoreMobileOptinWidgetSize()
      } else if (mobilecheck() && jQuery(window).width() + jQuery(window).height() != originalViewportSize) {
        // this means keyboard is visible
        shrinkMobileOptinWidget()
      }
    }

    buttonConfirm.onclick = function () {
      var phone = jQuery("#wa-optin-phone-number").val();
      if(!phone || phone.replace(/ /g,'').length < 6) {
        alert("Please enter a valid phone number")
        return
      }
      removeOptinWidget()


      if (phone) {
        localStorage.setItem("opted_in_phone_v2", phone);
        jQuery.ajax({
          url: SERVER_BASE_URL + '/shop/order/optin/v2',
          type: 'POST',
          dataType: 'json',
          contentType: 'application/json',
          data: JSON.stringify({
            "shop_id": getShopId(),
            "phone": phone
          })
        });
      }

      onDismiss()
    }

    var contentContainerParent = document.createElement("div");

    contentContainer.appendChild(textContent);
    widgetContainer.appendChild(contentContainer);
    jQuery('body').addClass('wa-optin-widget-stop-scrolling');

    var chatBtnWtsApp = document.getElementById("wa-chat-btn-root");

    blurContainer.appendChild(widgetContainer);
    jQuery(blurContainer).fadeIn()

    localStorage.setItem("optin_widget_last_shown", JSON.stringify(Date.now()));

    document.getElementById("wa-optin-phone-number").addEventListener('focus', (e) => {
      if (e.relatedTarget) {
        e.relatedTarget.removeAttribute('tabindex');
        e.target.focus();
      }
      return false;
    })
    if (!mobilecheck()) { jQuery("#wa-optin-phone-number").focus(); }

    if (localStorage.getItem("calling_code")) {
      jQuery("#wa-optin-phone-number").val("+" + localStorage.getItem("calling_code") + "  ");
      if (!mobilecheck()) { jQuery("#wa-optin-phone-number").focus(); }
      jQuery("#wa-splmn-country-flag-logo").html(localStorage.getItem("emoji_flag"));
    } else {
      jQuery.get(SERVER_BASE_URL + "/shop/ipinfo?shop_id=" + getShopId(), function (response) {
        if (response && response.calling_code) {
          jQuery("#wa-optin-phone-number").val("+" + response.calling_code + "  ");
          if (!mobilecheck()) { jQuery("#wa-optin-phone-number").focus(); }
          jQuery("#wa-splmn-country-flag-logo").html(response.emoji_flag);
          localStorage.setItem("calling_code", response.calling_code);
          localStorage.setItem("emoji_flag", response.emoji_flag);
        }
      }, "jsonp");
    }
  }

  function getCountryCodeFromCheckout(success) {
    if (Shopify.checkout && Shopify.checkout.shipping_address && Shopify.checkout.shipping_address.country_code) {
      jQuery.getJSON("https://cdn.shopify.com/s/files/1/0070/3666/5911/files/iso_code.json?1203", function (data) {
        success(data[Shopify.checkout.shipping_address.country_code] || "")
      })
    }
    return ""
  }

  function getPhoneFromShipping(country_code) {
    var raw_phone = ""
    if (Shopify.checkout && Shopify.checkout.shipping_address && Shopify.checkout.shipping_address.phone) {
      raw_phone = Shopify.checkout.shipping_address.phone
      switch (country_code) {
        case "91":
          if (raw_phone.startsWith(country_code) && raw_phone.length == 12) {
            return raw_phone
          } else if (raw_phone.startsWith(country_code) && raw_phone.length < 12) {
            return country_code + raw_phone
          } else if (!raw_phone.startsWith(country_code)) {
            return country_code + raw_phone
          }
        default:
          if (!raw_phone.startsWith(country_code)) {
            return country_code + raw_phone
          } else {
            return raw_phone
          }
      }
    }
    return country_code
  }

  function getOptinConfirmedText(widget_language) {
    switch (widget_language) {
      case 1:
        return "You will receive order and delivery updates at"
      case 2:
        return "Você receberá atualizações de pedidos e entregas em"
      case 3:
        return "Recibirá actualizaciones de pedidos y entregas en"
      case 4:
        return "Riceverai gli aggiornamenti dell'ordine e della consegna all'indirizzo"
      case 5:
        return "Vous recevrez les mises à jour de commande et de livraison à l'adresse"
      case 6:
        return "Anda akan menerima rincian pesanan dan informasi pengiriman dari"
      case 7:
        return "Sie erhalten Bestellund Lieferaktualisierungen unter"
      case 8:
        return "سوف تتلقى تحديثات الطلب والتسليم على"
      case 9:
        return "Sipariş ve gönderim güncellemelerini üzerinden alacaksınız"
      case 10:
        return "אתה תקבל הזמנות ועדכוני משלוח על המספר"
      case 11:
        return "Je ontvangt je order- en leveringsupdates op"
    }
  }

  function loadOptinConfirmed(widget_language, confirmed_phone) {
    var t = document.getElementsByClassName("section")[1]
    var f = t.childNodes[1]
    var d = document.createElement('div')
    d.className = "content-box"
    d.id = "wa-order-update-widget"

    var contentContainer = document.createElement('div')
    contentContainer.className = "content-box__row content-box__row--no-border"

    var contentHeader = document.createElement('h2')
    contentHeader.innerHTML = getConfirmedBtnText(widget_language)
    contentHeader.style = "color: #2EB840; text-align:left; margin-bottom:10px;"

    var contentTitle = document.createElement('p')
    contentTitle.className = "os-step__description"
    contentTitle.style = "margin-bottom:10px;"
    contentTitle.innerHTML = getOptinConfirmedText(widget_language) + ' <img style="display: inline-block;vertical-align: middle; width:30px; margin-bottom:6px;" src="https://cdn.shopify.com/s/files/1/0070/3666/5911/files/image_6.2_957b5e01-dd01-4e30-a595-d6f3bddef357.png?1197"/> ' + '<b>' + confirmed_phone + '</b>'

    contentContainer.appendChild(contentHeader)
    contentContainer.appendChild(contentTitle)

    d.appendChild(contentContainer)
    f.insertBefore(d, f.childNodes[3])
  }

  function getThankyouPageOptinText(widget_language) {
    switch (widget_language) {
      case 1:
        return "Receive order and delivery updates via WhatsApp."
      case 2:
        return "Receba atualizações de pedidos e entregas via WhatsApp."
      case 3:
        return "Reciba actualizaciones de pedidos y entregas a través de WhatsApp."
      case 4:
        return "Ricevi aggiornamenti su ordini e consegne tramite WhatsApp."
      case 5:
        return "Recevez les mises à jour de commande et de livraison via WhatsApp."
      case 6:
        return "Terima informasi rincian pesanan dan informasi pengiriman di Whatsapp."
      case 7:
        return "Erhalten Sie Bestellund Lieferaktualisierungen über WhatsApp."
      case 8:
        return "تلقي تحديثات الطلب والتسليم عبر WhatsApp."
      case 9:
        return "Sipariş ve gönderim güncellemelerini WhatsApp üzerinden al."
      case 10:
        return "קבלו הזמנות ועדכוני משלוח דרך הוואטסאפ"
      case 11:
        return "Ontvang order- en leveringsupdates op Whatsapp"
    }
  }

  function getOrderUpdatesOnText(widget_language) {
    switch (widget_language) {
      case 1:
        return "WhatsApp notifications"
      case 2:
        return "Notificações do WhatsApp"
      case 3:
        return "Notificaciones de WhatsApp"
      case 4:
        return "Notifiche di WhatsApp"
      case 5:
        return "Notifications WhatsApp"
      case 6:
        return "Pemberitahuan WhatsApp"
      case 7:
        return "WhatsApp-Benachrichtigungen"
      case 8:
        return "إشعارات WhatsApp"
      case 9:
        return "WhatsApp bildirimleri"
      case 10:
        return "התראות WhatsApp"
      case 11:
        return "WhatsApp-meldingen"
    }
  }

  function thankYouPageOptinWidget(widget_language) {
    var style = document.createElement('style');
    style.type = 'text/css';
    style.innerHTML = '.numberContainer {} .numberContainer input{border: 0.05px solid; border-color: grey;} .numberInput { padding: 10px; height: 38px; font-size: 16px; width: 62%; box-sizing: border-box;} .confirmBtn { display: inline; vertical-align: baseline; height: 42px; border-radius: 0px 100px 100px 0px; background: #2EB840; color: white; border-style: solid; padding-left: 10px; padding-right: 10px; position: relative; right: 24px; border: none; outline: none; font-size: 16px; width: 38%} .confirmBtn:hover {box-shadow: 2px 2px 16px rgba(0, 0, 0, 0.2);}'
    document.head.appendChild(style);


    var t = document.getElementsByClassName("section")[1]
    var f = t.childNodes[1]
    var d = document.createElement('div')
    d.className = "content-box"
    d.id = "wa-order-update-widget"

    var contentContainer = document.createElement('div')
    contentContainer.className = "content-box__row content-box__row--no-border"

    var contentHeader = document.createElement('h2')
    contentHeader.innerHTML = ''
    contentHeader.innerHTML = '<img style="vertical-align: middle;margin-bottom:8px" src="https://cdn.shopify.com/s/files/1/0070/3666/5911/files/image_6.2_957b5e01-dd01-4e30-a595-d6f3bddef357.png?1197"/>' + getOrderUpdatesOnText(widget_language)

    var contentTitle = document.createElement('p')
    contentTitle.className = "os-step__description"
    contentTitle.innerHTML = getThankyouPageOptinText(widget_language)

    var numberContainer = document.createElement('div')
    numberContainer.style = "text-align: left; margin-top: 10px; margin-bottom: 14px;"
    numberContainer.className = "numberContainer"
    numberContainer.innerHTML = '<input id="wa-optin-widget-thankyou-phone" class="numberInput" type="tel" placeholder="+XXX XXXXXXXXX"></input><button class="confirmBtn" id="wa-optin-widget-thankyou-confirm-btn">' + getConfirmBtnText(widget_language) + '</button></div>'

    contentContainer.appendChild(contentHeader)
    contentContainer.appendChild(contentTitle)
    contentContainer.appendChild(numberContainer)

    d.appendChild(contentContainer)
    f.insertBefore(d, f.childNodes[3])


    jQuery('#wa-optin-widget-thankyou-confirm-btn').on('click', function () {
      var phone = jQuery('#wa-optin-widget-thankyou-phone').val()
      if(!phone || phone.replace(/ /g,'').length < 6) {
        alert("Please enter a valid phone number")
        return
      }
      if (phone && Shopify.checkout.order_id) {
        customOptinFromThankYouPage(phone)
        loadOptinConfirmed(widget_language, phone)
      }
    })

    if (Shopify.checkout && Shopify.checkout.phone) {
      jQuery("#wa-optin-widget-thankyou-phone").val(Shopify.checkout.phone)
    } else {
      getCountryCodeFromCheckout(function (cc) {
        var phone = getPhoneFromShipping(cc)
        jQuery("#wa-optin-widget-thankyou-phone").val("+" + phone)
      })
    }
  }

  function createWhatsappShareBtn(settings) {

    var current_device_type = deviceType();
    // if (settings.is_share_enabled && (settings.device_type & current_device_type) != 0 && isProductPage()) {

    if (settings.is_share_enabled && (settings.device_type & current_device_type) != 0 && isShareBtnVisible(settings)) {

      var d = document.createElement('div');
      d.className = "wa-share-btn-container";

      var textColorStr = '';
      var bgColor1 = settings.share_btn_bg_color_1;
      var bgColor2 = settings.share_btn_bg_color_2;
      var iconColor = settings.share_btn_icon_color || '#ffffff';
      if(settings.is_share_btn_color_custom) {
        if(settings.is_share_btn_solid_background) {
          d.style = `background: ${bgColor1 || '#22ce5b'}`
        } else {
          d.style = `background-image: linear-gradient(90deg, ${bgColor1} 0%, ${bgColor2} 100%);`
        }
        textColorStr = `color: ${settings.share_btn_text_color || '#ffffff'}`
      }

      //zIndex from settings
      var style = document.createElement('style');
      style.type = 'text/css';
      style.innerHTML = '.wa-share-btn-z-index { z-index:' + (current_device_type === 1 ? settings.share_button_z_index_mobile : settings.share_button_z_index_desktop) + ';}';
      document.head.appendChild(style);

      d.className += " wa-share-btn-pos-" + getButtonPosition(current_device_type, settings)
      d.className += " " + getShareButtonTheme(settings.btn_template) + " " + "wa-share-btn-z-index" + " " + "wa-share-btn-theme-" + settings.btn_template;

      var img_url = getShareButtonImg(settings.btn_template)
      var imgStr = `<img src="${img_url}" class="wa-share-btn-img"></img>`;
      if(settings.is_share_btn_color_custom) {
        imgStr = `<div class="wa-share-btn-img wa-share-icon wa-share-mask" style="background: ${iconColor}"></div>`
      }
      d.innerHTML += '<p class="wa-share-btn-cta" style="' + textColorStr + '">' + settings.btn_cta + '</p>' + imgStr;

      var message = getFinalWhatsappShareMsg(settings)
      var link = getWhatsappLink(null, message, current_device_type)

      d.onclick = onShareBtnClick(link)
      document.body.appendChild(d)
    }
  }

  function getButtonAlignment(settings) {
    if(settings.button_alignment == 2) {
      return "top"
    } else {
      return "bottom"
    }
  }

  function createWhatsappBtn(settings) {
    var current_device_type = deviceType()
    // if ((settings.is_chat_enabled && (settings.device_type & current_device_type) != 0) && settings.agents.length > 0 && settings.agents[0].phone && settings.is_store_open) {

    if ((settings.is_chat_enabled && (settings.device_type & current_device_type) != 0) 
        && settings.agents.length > 0 
        && settings.agents[0].phone 
        && (settings.show_button || (settings.is_store_open && isAtleastOneAgentAvailable(settings))) 
        && isWhatsAppBtnVisible(settings)) {

      var style = document.createElement('style');
      style.type = 'text/css';

      var btn_template = settings.btn_template;

      //zindex from settings
      style.innerHTML = '.wa-splmn-chat-btn-offset {' + getButtonAlignment(settings) + ': ' + getHeightOffset(current_device_type, settings) + 'px;' + getButtonPosition(current_device_type, settings) + ':' + getHorizontalOffset(current_device_type, settings) + ';' + 'z-index:' + (current_device_type === 1 ? settings.chat_button_z_index_mobile : settings.chat_button_z_index_desktop) + ';}';
      document.head.appendChild(style);

      var d = document.createElement('div')
      d.id = "wa-chat-btn-root";

      d.className = "wa-chat-btn-fixed wa-splmn-chat-btn-offset";

      if (!btn_template.icon_url) {
        btn_template.icon_url = "https://cdn.shopify.com/s/files/1/0265/2572/8803/files/wa.svg?v=1586952948"
      }

      var is_chat_btn_solid_background = settings.is_chat_btn_solid_background;
      var bgColor1 = settings.chat_btn_bg_color_1 || btn_template.bg_color_1 || '#20802C';
      var bgColor2 = settings.chat_btn_bg_color_2 || btn_template.bg_color_2 || '#30BF42';
      var iconColor = settings.chat_btn_icon_color || '#ffffff';
      var chat_btn_text_color = settings.chat_btn_text_color || btn_template.text_color || '#ffffff';
      var mainStyleStr = '';
      var imgStyleStr = '';
      var textStyleStr = '';
      var iconStyleStr = '';
      var iconClass = '';

      if (settings.is_chat_btn_color_custom) {
        d.className += ' wa-custom-chat-btn';
        textStyleStr = `color: ${chat_btn_text_color}`;

        iconStyleStr = `background: ${iconColor}; -webkit-mask-image: url(${btn_template.icon_url}); -webkit-mask-size: cover; -webkit-mask-position: center;`;

        if (btn_template.btn_custom_class.includes("wa-chat-btn-base-cta-with-icon")) {
          if (is_chat_btn_solid_background) {
            imgStyleStr = `background: ${bgColor1};`;
          } else {
            imgStyleStr = `background-image: linear-gradient(112.42deg, ${bgColor1} 0%, ${bgColor1} 0.01%, ${bgColor2} 100%); -webkit-mask-image: url(${btn_template.icon_url}); -webkit-mask-size: cover; -webkit-mask-position: center;`;
          }

          if (btn_template.icon_custom_class.includes("no-box-shadow")) {
            iconClass += ' ' + 'no-box-shadow';
          }
        } else {
          if (is_chat_btn_solid_background) {
            mainStyleStr = `background: ${bgColor1};`;
          } else {
            mainStyleStr = `background-image: linear-gradient(112.42deg, ${bgColor1} 0%, ${bgColor1} 0.01%, ${bgColor2} 100%);`    
          }
          
          imgStyleStr += iconStyleStr;

          if (btn_template.icon_custom_class.includes("no-box-shadow")) {
            d.className += ' ' + 'no-box-shadow';
            iconClass += ' ' + 'no-box-shadow';
          }
        }

        if (btn_template.btn_custom_class.includes("bordered")) {
          mainStyleStr += ' ' + 'border: 1px solid ' + iconColor;
        }
        d.style = mainStyleStr;
      }

      if (settings.btn_template && settings.btn_template.btn_custom_class) {
        d.className += " " + settings.btn_template.btn_custom_class
      } else {
        d.className += " wa-chat-btn-default"
      }

      var btn_position = getButtonPosition(current_device_type, settings);

      var defaultTextMarkUp = `<div class="wa-chat-button-cta-text" style="${textStyleStr}">${settings.btn_cta}</div>`;
      var defaultImageMarkUp = settings.is_chat_btn_color_custom ? `<div class="${btn_template.icon_custom_class} wa-custom-icon" style="${imgStyleStr}"></div>` : `<img class="${settings.btn_template.icon_custom_class}" style="${imgStyleStr}" src=${settings.btn_template.icon_url}/>`;

      if (settings.btn_template && settings.btn_template.btn_custom_class.includes("wa-chat-btn-base-cta-with-icon") && settings.btn_template.is_cta_enabled){
        if (settings.is_chat_btn_color_custom) {
          defaultImageMarkUp = `<div class="wa-chat-btn-base-icon ${iconClass}" style="${imgStyleStr}">
            <div style="${iconStyleStr}" class="${ btn_template.icon_custom_class }"></div>
          </div>`;
        }

        d.innerHTML = btn_position === 'right' ? defaultTextMarkUp + defaultImageMarkUp : defaultImageMarkUp + defaultTextMarkUp;
      } else if (settings.btn_template && settings.btn_template.is_cta_enabled) {
        d.innerHTML = defaultImageMarkUp + defaultTextMarkUp;
      } else if (settings.btn_template) {
        d.innerHTML = defaultImageMarkUp+'<span></span>'
      } else {
        d.innerHTML = '<img class="wa-chat-btn-default-waicon" src="https://cdn.shopify.com/s/files/1/0021/6799/6525/files/whatsicon.png?11367248219507062847"/><div class="wa-chat-button-cta-text">' + settings.btn_cta + '</div>'
      }

      d.onclick = onClick(settings, current_device_type)
      document.body.appendChild(d);
    }
  }

  function fetchStoreSettings(shop_id, success_callback) {
    jQuery.ajax({
      url: SERVER_BASE_URL + '/shop/setting?shop_id=' + shop_id,
      type: 'GET',
      success: function (settings) {
        success_callback(settings)
      }
    });
  }

  function getShopId() {
    if (window.Shopify != undefined) {
      return window.Shopify.shop
    }

    var domain;
    var url = window.location.href
    if (url.indexOf("://") > -1) {
      domain = url.split('/')[2];
    } else {
      domain = url.split('/')[0];
    }
    domain = domain.split(':')[0];
    return domain;
  }

  var shop_id = getShopId()
  var current_device_type = deviceType()
  if (!window.splmn_wa_chat_init) {
    window.splmn_wa_chat_init = true
    fetchStoreSettings(shop_id, function (settings) {

      var _originalSize = jQuery(window).width() + jQuery(window).height()

      if (settings.optin_widget_template == 1) {
        createOptinWidget(settings, _originalSize)
      } else {
        createOldOptinWidget(settings, _originalSize)
      }

      createWhatsappBtn(settings.chatsetting)

      loadCalloutCard(settings.chatsetting, current_device_type)

      createWhatsappShareBtn(settings.sharesetting)

    })
  }
}

(function () {
  initJQuery(function () {
    initCss(function () {
      btnLoad()
    });
  });
})();

function openInNewTab (href) {
  Object.assign(document.createElement('a'), {
    target: '_blank',
    href: href
  }).click();
}